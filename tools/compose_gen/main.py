from __future__ import annotations

from pathlib import Path
from typing import Any

import yaml

from . import services, stacks


def read_version() -> str:
    """Read version from root version file."""
    version_file = Path(__file__).parent.parent.parent / "version"
    return version_file.read_text().strip()


def write_compose_file(config: dict[str, Any], output_path: Path) -> None:
    """Write configuration to YAML file with header."""
    output_path.parent.mkdir(parents=True, exist_ok=True)

    with open(output_path, "w") as f:
        f.write("# Code generated by Python script. DO NOT EDIT.\n")
        yaml.dump(
            config, f, sort_keys=False, default_flow_style=False, allow_unicode=True
        )


def main() -> None:
    """Generate all Docker Compose configurations."""
    version = read_version()
    docker_dir = Path(__file__).parent.parent.parent / "docker"

    # Define all configurations
    configs: dict[str, dict[str, Any]] = {
        "mainnet-dbsync/compose": {
            "services": {
                "db": services.db.mk_service(
                    services.db.Options(host_port=5432)
                ).model_dump(exclude_none=True),
                "neoprism-indexer": services.neoprism.mk_service(
                    services.neoprism.Options(
                        host_port=8080,
                        dlt_source=services.neoprism.DbSyncDltSource(
                            type="dbsync",
                            args=services.neoprism.DbSyncDltSourceArgs(
                                url="<DBSYNC_URL>"
                            ),
                        ),
                    ),
                    version,
                ).model_dump(exclude_none=True),
            }
        },
        "mainnet-relay/compose": {
            "services": {
                "db": services.db.mk_service(
                    services.db.Options(host_port=5432)
                ).model_dump(exclude_none=True),
                "neoprism-indexer": services.neoprism.mk_service(
                    services.neoprism.Options(
                        host_port=8080,
                        dlt_source=services.neoprism.RelayDltSource(
                            type="relay",
                            address="backbone.mainnet.cardanofoundation.org:3001",
                        ),
                    ),
                    version,
                ).model_dump(exclude_none=True),
            }
        },
        "preprod-relay/compose": {
            "services": {
                "db": services.db.mk_service(
                    services.db.Options(host_port=5432)
                ).model_dump(exclude_none=True),
                "neoprism-indexer": services.neoprism.mk_service(
                    services.neoprism.Options(
                        host_port=8080,
                        network="preprod",
                        dlt_source=services.neoprism.RelayDltSource(
                            type="relay",
                            address="preprod-node.play.dev.cardano.org:3001",
                        ),
                    ),
                    version,
                ).model_dump(exclude_none=True),
            }
        },
        "prism-test/compose": stacks.prism_test.mk_stack(
            stacks.prism_test.Options(ci=False), version
        ).model_dump(exclude_none=True),
        "prism-test/compose-ci": stacks.prism_test.mk_stack(
            stacks.prism_test.Options(ci=True), version
        ).model_dump(exclude_none=True),
        "blockfrost-neoprism-demo/compose": stacks.blockfrost_neoprism_demo.mk_stack(
            stacks.blockfrost_neoprism_demo.Options(), version
        ).model_dump(exclude_none=True),
        "mainnet-universal-resolver/compose": stacks.universal_resolver.mk_stack(
            version
        ).model_dump(exclude_none=True),
    }

    # Generate all compose files
    for name, config in configs.items():
        output_path = docker_dir / f"{name}.yml"
        write_compose_file(config, output_path)
        print(f"Generated: {output_path}")


if __name__ == "__main__":
    main()
