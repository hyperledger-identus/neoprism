services:

  ################################
  # Cardano
  ################################

  cardano-node:
    image: cardano-testnet:latest
    ports:
    - 3001:3001
    volumes:
    - node-testnet:/node/testnet
    command:
    - initTestnet
    healthcheck:
      test: [ "CMD-SHELL", "cardano-cli query tip" ]
      interval: 5s
      start_period: 5s
      timeout: 2s
      retries: 10
    environment:
      CARDANO_NODE_SOCKET_PATH: /node/testnet/socket/node1/sock
      CARDANO_NODE_NETWORK_ID: "42"

  cardano-wallet:
    image: cardanofoundation/cardano-wallet:2025.3.31
    restart: always
    ports:
    - 8090:8090
    volumes:
    - node-testnet:/node/testnet
    entrypoint: []
    command:
    - bash
    - -c
    - |
      cardano-wallet serve \
        --database /wallet/db \
        --node-socket /node/testnet/socket/node1/sock \
        --testnet /node/testnet/byron-genesis.json \
        --listen-address 0.0.0.0
    depends_on:
      cardano-node:
        condition: service_healthy

  bootstrap-wallet:
    image: cardano-testnet:latest
    volumes:
    - node-testnet:/node/testnet
    command:
    - transactGenesis
    environment:
      CARDANO_NODE_SOCKET_PATH: /node/testnet/socket/node1/sock
      CARDANO_NODE_NETWORK_ID: "42"
    depends_on:
      cardano-node:
        condition: service_healthy

  ################################
  # DB Sync
  ################################

  cardano-dbsync:
    image: ghcr.io/intersectmbo/cardano-db-sync:13.6.0.5
    restart: always
    environment:
      POSTGRES_HOST: postgres-dbsync
      POSTGRES_DB: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    command:
    - --config
    - /config/dbsync-config.yaml
    - --socket-path
    - /node/testnet/socket/node1/sock
    - --force-indexes
    volumes:
      - node-testnet:/node/testnet
      - ./dbsync-config.yaml:/config/dbsync-config.yaml
    depends_on:
      cardano-node:
        condition: service_healthy
      postgres-dbsync:
        condition: service_healthy

  postgres-dbsync:
    image: postgres:17
    restart: always
    ports:
    - 5432:5432
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    command: [
        # "-c", "log_statement=all",
        # "-c", "log_lock_waits=on",
        "-c", "maintenance_work_mem=1GB" ,
        "-c", "max_parallel_maintenance_workers=4"
      ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  ################################
  # PRISM node
  ################################

  # postgres-prism-node:
  #   image: postgres:17
  #   restart: always
  #   ports:
  #   - 5433:5432
  #   environment:
  #     POSTGRES_DB: postgres
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: postgres
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  node-testnet: {}
